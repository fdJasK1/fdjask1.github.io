---
date: "2025-04-30T21:11:31+08:00"
draft: false
title: "BUAA_2025_OS_Lab3 ä¸Šæœºæ€»ç»“"

tags: ["BUAA", "OS"]
categories: ["course"]
ShowWordCount: true
summary: åŒ—èˆª2025å¹´æ“ä½œç³»ç»ŸLab3ä¸Šæœºé¢˜ç›®å›é¡¾åŠåˆ†æ
---
ç¬”è€…å¥½ä¸å®¹æ˜“é€šè¿‡ä¸€æ¬¡ extra ï¼Œååˆ†é«˜å…´ï¼Œé‚åœ¨æ­¤è®°å½•æœ¬æ¬¡ä¸Šæœºå†…å®¹ã€‚ä¸Šæœºå‰ï¼Œä¾æ—§æ˜¯å‚è€ƒäº†å¾€å¹´åšå®¢ï¼Œäº†è§£åˆ° extra ä¼šè€ƒå¯Ÿå¼‚å¸¸å¤„ç†ï¼Œå› æ­¤æå‰æµè§ˆäº†å¾€å±Šä»£ç ï¼Œå­¦ä¹ å¼‚å¸¸å¤„ç†çš„å¤§ä½“æµç¨‹ï¼›æ­¤å¤–ï¼Œä»åŸä»“å‘¨è€å¸ˆç­ä¸Šçš„åŒå­¦å¤„è·çŸ¥æ¶ˆæ¯ï¼Œexam ä¼šè€ƒå¯ŸEDFè°ƒåº¦ç®—æ³•ï¼Œå¯¹ç…§ç†è®ºè¯¾è¯¾ä»¶ä¹Ÿå‡†å¤‡äº†ä¸€ä¸‹ã€‚

## exam

è¯¾ä¸‹æˆ‘ä»¬åœ¨ MOS ç³»ç»Ÿä¸­å®ç°äº†æ—¶é—´ç‰‡è½®è½¬ç®—æ³•ï¼ˆRound-Robinï¼ŒRRï¼‰ç”¨äºè¿›ç¨‹è°ƒåº¦ã€‚åœ¨æœ¬é¢˜ä¸­ï¼Œæˆ‘ä»¬å°†å®ç°æœ€æ—©æˆªæ­¢æ—¶é—´ä¼˜å…ˆç®—æ³•ï¼ˆEarliest Deadline Firstï¼ŒEDFï¼‰ï¼Œç”¨äºè°ƒåº¦å‘¨æœŸæ€§è¿›ç¨‹ã€‚

---
é¢˜å¹²ä¸­æç¤ºæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

- åœ¨ include/env.h ä¸­æ·»åŠ å£°æ˜ï¼š

    ```c
    LIST_HEAD(Env_edf_sched_list, Env);

    extern struct Env_edf_sched_list env_edf_sched_list; // EDF è°ƒåº¦é˜Ÿåˆ—

    struct Env *env_create_edf(const void *binary, size_t size, int runtime, int period);
    ```

- åœ¨ include/env.h ä¸­çš„`Env`ç»“æ„ä½“ä¸­æ·»åŠ å¿…è¦å­—æ®µï¼š

    ```c
        LIST_ENTRY(Env) env_edf_sched_link; // æ„é€  env_edf_sched_list çš„é“¾è¡¨é¡¹
        u_int env_edf_runtime; // EDF è°ƒåº¦å‚æ•°ï¼šè¿›ç¨‹åœ¨æ¯ä¸ªå‘¨æœŸå†…éœ€è¦è¿è¡Œçš„æ—¶é—´ç‰‡
        u_int env_edf_period; // EDF è°ƒåº¦å‚æ•°ï¼šè¿›ç¨‹çš„è¿è¡Œå‘¨æœŸ
        u_int env_period_deadline; // è¿›ç¨‹å½“å‰å‘¨æœŸçš„æˆªæ­¢æ—¶é—´
        u_int env_runtime_left; // è¿›ç¨‹å½“å‰å‘¨æœŸå‰©ä½™çš„æ—¶é—´ç‰‡
    ```

- åœ¨ kern/env.c ä¸­æ·»åŠ `env_edf_sched_list`çš„å®šä¹‰ï¼Œ**å¹¶åœ¨`env_init`å‡½æ•°ä¸­åˆå§‹åŒ–**`env_edf_sched_list`:

    ```c
    struct Env_edf_sched_list env_edf_sched_list;
    ```

    é¢˜å¹²ä¸­åªç»™å‡ºäº†`env_edf_sched_list`çš„å®šä¹‰ï¼Œéœ€è¦æ‰‹åŠ¨åˆå§‹åŒ–ä¸€ä¸‹ã€‚åœ¨`env_free_list`å’Œ`env_sched_list`çš„åˆå§‹åŒ–ä»£ç ä¸‹æ–¹è°ƒç”¨`LIST`çš„åˆå§‹åŒ–å®å³å¯ï¼Œå¾ˆç®€å•ï¼š
   
   ```c
   /* Exercise 3.1: Your code here. (1/2) */
	TAILQ_INIT(&env_sched_list);
	LIST_INIT(&env_free_list);
    LIST_INIT(&env_edf_sched_list);
    ```
---
åŸºäºä»¥ä¸Šå†…å®¹ï¼Œæœ¬é¢˜æœ‰ä¸¤æ­¥éœ€è¦å®ç°ï¼š

1. åœ¨ kern/env.c ä¸­ä»¿ç…§`env_create`å®ç°å‡½æ•°`env_create_edf`ï¼Œç”¨äºåˆ›å»ºå‘¨æœŸæ€§è¿›ç¨‹ï¼Œå¹¶è¿”å›æŒ‡å‘è¢«åˆ›å»ºè¿›ç¨‹çš„è¿›ç¨‹æ§åˆ¶å—çš„æŒ‡é’ˆã€‚å‚è€ƒå¦‚ä¸‹ï¼š

    ```c
    struct Env *env_create_edf(const void *binary, size_t size, int runtime, int period) {
        ...
        e->env_edf_runtime = runtime;
        e->env_edf_period = period;
        e->env_period_deadline = 0; // åˆå§‹åŒ–ä¸º 0ï¼Œä½¿è¿›ç¨‹åœ¨é¦–æ¬¡è°ƒç”¨ schedule å‡½æ•°æ—¶è§¦å‘æ¡ä»¶åˆ¤æ–­ï¼Œè¿›å…¥é¦–ä¸ªè¿è¡Œå‘¨æœŸ
        e->env_status = ENV_RUNNABLE;

        ...
    }
    ```

2. ä¿®æ”¹ kern/sched.c ä¸­çš„`schedule`å‡½æ•°ï¼Œå®ç° EDF è°ƒåº¦ç®—æ³•ã€‚å‚è€ƒå®ç°æ–¹å¼å¦‚ä¸‹:

    ```c
    void schedule(int yield) {
        static int clock = -1; // å½“å‰æ—¶é—´ç‰‡ï¼Œä» 0 å¼€å§‹è®¡æ•°
        clock++;

        /* (1) éå† env_edf_sched_listï¼Œå¦‚æœè¿›ç¨‹è¿›å…¥äº†æ–°çš„è¿è¡Œå‘¨æœŸï¼ˆå¯é€šè¿‡ clock == env_p
        /* åœ¨æ­¤å®ç°ä½ çš„ä»£ç  */
        /* (2) éå† env_edf_sched_listï¼Œé€‰å– env_runtime_left å¤§äº 0 ä¸” env_period_dead
        /* åœ¨æ­¤å®ç°ä½ çš„ä»£ç  */
        /* (3) ä½¿ç”¨è¯¾ä¸‹å®ç°çš„ RR ç®—æ³•è°ƒåº¦ env_sched_list ä¸­çš„è¿›ç¨‹ã€‚ */
        static int count = 0; // remaining time slices of current env
        struct Env *e = curenv; // è¯·æ ¹æ®æç¤ºä¿®æ”¹è¿™è¡Œä»£ç 
        /* è¯·å°† Exercise 3.12 ä¸­çš„ä»£ç ç²˜è´´è‡³æ­¤ */
    }
    ```

---
å…ˆåˆ†æè¾ƒç®€å•çš„`env_create_edf`ï¼Œå‚ç…§åŸç‰ˆçš„`env_create`å¯ä»¥å‘ç°æç¤ºå†…å®¹ä»¥å¤–åªå‰©ä¸¤å¤„éœ€è¦æ”¹åŠ¨ï¼šå‚æ•°ä¸­æ— `priority`ï¼Œä¸å†éœ€è¦ç»™`env_pri`èµ‹å€¼ï¼ˆç”¨ EDF è°ƒåº¦æ—¶ä¹Ÿä¸éœ€è¦è¯¥å­—æ®µï¼‰ï¼›ç”±äº EDF ç®—æ³•ä¸éœ€è¦åœ¨é˜Ÿå°¾æ’å…¥æˆ–å–å‡ºçš„æ“ä½œï¼Œå› æ­¤æˆ‘ä»¬æ¨èä½¿ç”¨`LIST`ç»“æ„å®ç° EDF è°ƒåº¦é˜Ÿåˆ—ï¼Œå› æ­¤æœ€åä¸€æ­¥å°†`e`åŠ å…¥`env_sched_list`æ‰€ä½¿ç”¨å®æœ‰æ‰€ä¸åŒã€‚æœ€ç»ˆä»£ç å¦‚ä¸‹ï¼š

```c
struct Env *env_create_edf(const void *binary, size_t size, int runtime, int period) {
	struct Env *e;
	panic_on(env_alloc(&e, 0));

	e->env_edf_runtime = runtime;
	e->env_edf_period = period;
	e->env_period_deadline = 0; // åˆå§‹åŒ–ä¸º 0ï¼Œä½¿è¿›ç¨‹åœ¨é¦–æ¬¡è°ƒç”¨ schedule å‡½æ•°æ—¶è§¦å‘æ¡ä»¶åˆ¤æ–­ï¼Œè¿›å…¥é¦–ä¸ªè¿è¡Œå‘¨æœŸ
	e->env_status = ENV_RUNNABLE;

	load_icode(e, binary, size);
	LIST_INSERT_HEAD(&env_edf_sched_list, e, env_edf_sched_link);

	return e;
}
```
---
è€Œå¯¹äºè°ƒåº¦ç®—æ³•çš„ä¿®æ”¹ç•¥å¾®éº»çƒ¦ä¸€ç‚¹ï¼Œå…ˆè®¾ç½®å¾ªç¯å˜é‡`struct Env *env`ï¼Œä¹‹åæŒ‰ç…§æç¤ºä¸€æ­¥æ­¥è¿›è¡Œï¼š

1. éå†`env_edf_sched_lsit`å†…çš„è¿›ç¨‹è¿›è¡Œå¿…è¦çš„ä¿®æ”¹ï¼Œå…¶ä¸­æ›´æ–°`env_period_deadline`è¿™ä¸€æ­¥é¢˜å¹²ä¸­æ²¡æœ‰æ˜ç¡®æŒ‡å‡ºåšæ³•ï¼Œä½†æ ¹æ®ç†è®ºè¯¾çŸ¥è¯†å’Œé¢˜é¢çš„ç›¸å…³çŸ¥è¯†ï¼Œå¯ä»¥åˆ¤æ–­ä¸ºè‡ªå¢`env->env_edf_period`ï¼š

    ```c
    LIST_FOREACH (env, &env_edf_sched_list, env_edf_sched_link) {
		if (clock == env->env_period_deadline) {
			env->env_period_deadline +=  env->env_edf_period;
			env->env_runtime_left = env->env_edf_runtime;
		}
	}
    ```

2. äºŒæ¬¡éå†ï¼Œå¹¶æ‰¾å‡ºç¬¦åˆè¦æ±‚çš„è¿›ç¨‹ï¼š

    ```c
    // æå‰è®¾ç½®å¥½å¯»æ‰¾æœ€å°å€¼çš„å˜é‡å’Œæ ‡è®°å¯»æ‰¾æˆåŠŸçš„å˜é‡
    LIST_FOREACH (env, &env_edf_sched_list, env_edf_sched_link) {
		if (env->env_runtime_left > 0) {
			if (env->env_period_deadline < minddl || 
                env->env_period_deadline == minddl && env->env_id < minid) {
				minddl = env->env_period_deadline;
				minid = env->env_id;
				flag = 1;
				e = env;
			}
		}
	}
    ```

    éšåè¿›è¡Œè°ƒåº¦ï¼Œå³å‡å°`e->env_runtime_left`ã€‚ç¬”è€…æœ€åˆå¿˜è®°è¿™ä¸€æ­¥ï¼Œå¯¼è‡´æœ¬åœ°æµ‹è¯•æ€»æ˜¯æ— æ³•åœ¨500æ¬¡å†…è°ƒåº¦å®Œæ‰€æœ‰è¿›ç¨‹ï¼Œä½†ä½¿ç”¨printæ³•è°ƒè¯•å¾ˆå¿«å°±èƒ½å‘ç°é—®é¢˜ã€‚

    ```c
    if (flag) {
        e->env_runtime_left--;
    }
    ```

3. å¤„ç† EDF ç®—æ³•è°ƒåº¦å¤±è´¥çš„æƒ…å†µ

    å½“`flag`ä¸º0æ—¶ï¼Œéœ€è¦ä½¿ç”¨è¯¾ä¸‹å®ç°çš„ RR è°ƒåº¦ç®—æ³•ã€‚
    
    > é¢˜é¢æç¤ºï¼šåœ¨è¯¾ä¸‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰`struct Env *e = curenv`ï¼Œéšåå¯¹`e`è¿›è¡Œäº†ä¸€ç³»åˆ—çš„åˆ¤æ–­å’Œæ“ä½œã€‚åœ¨æœ¬é¢˜ä¸­ï¼Œä¸ºäº†ä½¿ RR ç®—æ³•çš„è°ƒåº¦è¡Œä¸ºä¸å— EDF æŠ¢å çš„å½±å“ï¼Œä½ å¯èƒ½éœ€è¦é€‚å½“ä¿®æ”¹è¿™ä¸€è®¾è®¡ï¼Œä½¿`e`çš„åˆå€¼ä¸ºä¸Šæ¬¡ä½¿ç”¨ RR ç®—æ³•è°ƒåº¦çš„è¿›ç¨‹ï¼Œå¹¶åœ¨å¿…è¦æ—¶æ–°å¢**å…¨å±€å˜é‡æˆ–é™æ€å˜é‡**ã€‚

    è¿™ä¸€æç¤ºçš„åšæ³•å¾ˆå¸¸ç”¨ï¼Œåœ¨å¾€å¹´ä¹Ÿå¤šæ¬¡å‡ºç°ã€‚å…·ä½“æ¥è¯´ï¼Œæœ¬é¢˜ä¸­è®¾ç½®ä¸€ä¸ª`static struct Env *last`è®°å½•ä¸Šæ¬¡ä½¿ç”¨ RR ç®—æ³•è°ƒåº¦çš„è¿›ç¨‹å³å¯ã€‚å°†`last`åˆå§‹åŒ–ä¸º`NULL`ï¼Œå¹¶è®°å¾—åœ¨ç§»é™¤`e`æ—¶åˆ¤æ–­æ˜¯å¦ä¸º`NULL`ï¼ˆå³ç¬¬ä¸€æ¬¡è°ƒåº¦ï¼‰ã€‚ç¬”è€…åœ¨è¿™é‡Œåˆå¡äº†ä¸€ä¼šï¼Œè¯¾åçœ‹æ°´ç¾¤é‡Œä¹Ÿæœ‰åŒå­¦åœ¨è¿™é‡Œé‡åˆ°äº†é—®é¢˜ã€‚

    ```c
    if (!flag) {
		/* (3) ä½¿ç”¨è¯¾ä¸‹å®ç°çš„ RR ç®—æ³•è°ƒåº¦ env_sched_list ä¸­çš„è¿›ç¨‹ã€‚ */
        e = last == NULL ? curenv : last; // è¿™é‡Œä¼¼ä¹æ˜¯å¤šä½™çš„
		/* è¯·å°† Exercise 3.12 ä¸­çš„ä»£ç ç²˜è´´è‡³æ­¤ */
		if (yield || count == 0 || e == NULL || e->env_status != ENV_RUNNABLE) {
        	if (last != NULL && e != NULL && e->env_status == ENV_RUNNABLE) {
        	    TAILQ_REMOVE(&env_sched_list, e, env_sched_link);
        	    TAILQ_INSERT_TAIL(&env_sched_list, e, env_sched_link);
        	}
       		e = TAILQ_FIRST(&env_sched_list);
        	if (e == NULL) {
            	panic("schedule: no runnable envs\n");
        	}
        	count = e->env_pri;
        	last = e;
    	}
        count--;
	}
    ```

---
æœ¬æ¬¡examé¢˜ç›®ä¸ç®—ç‰¹åˆ«éš¾ï¼Œå°¤å…¶æ˜¯ä¸Šæœºå‰å‡†å¤‡å……è¶³çš„æƒ…å†µä¸‹ï¼Œæ›´åº”è¯¥å¯¹è€ƒå¯Ÿå†…å®¹è®¤è¯†æ¯”è¾ƒåˆ°ä½äº†ã€‚ä½†ç¬”è€…å› ä¸ºæ–‡ä¸­æåˆ°çš„å‡ å¤„â€œå°é—®é¢˜â€å¡äº†å¾ˆä¹…ï¼Œå¤§çº¦è€—æ—¶1h15minæ‰é€šè¿‡ã€‚ğŸ˜¥ 

## extra

è¯¾ä¸‹å®éªŒä¸­ï¼Œæˆ‘ä»¬ä¸»è¦ä»‹ç»äº†å¼‚å¸¸çš„åˆ†å‘ã€å¼‚å¸¸å‘é‡ç»„å’Œ 0 å·å¼‚å¸¸ï¼ˆæ—¶é’Ÿä¸­æ–­ï¼‰çš„å¤„ç†è¿‡ç¨‹ã€‚åœ¨æœ¬æ¬¡ Extra ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å¤§å®¶æ‹“å±• 4 å·å¼‚å¸¸ AdEL å’Œ 5 å·å¼‚å¸¸ AdES çš„å¼‚å¸¸åˆ†å‘ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šå®ç°è‡ªå®šä¹‰çš„å¼‚å¸¸å¤„ç†ã€‚

ç»è¿‡COçš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“å¯¼è‡´è¿™ä¸¤ç§å¼‚å¸¸å‘ç”Ÿçš„åŸå› å¯èƒ½æ˜¯åœ°å€ä¸å¯¹é½æˆ–è¿åè®¿é—®æƒé™ã€‚åœ¨æœ¬é¢˜ä¸­ï¼Œåªè€ƒè™‘**åœ°å€ä¸å¯¹é½**å¯¼è‡´çš„ä¸Šè¿°é”™è¯¯ï¼Œä¸”åªè€ƒè™‘ lw å’Œ sw æŒ‡ä»¤ï¼ˆå³å¿…é¡»å››å­—èŠ‚å¯¹é½ï¼‰çš„æƒ…å†µã€‚å…·ä½“çš„å“åº”æ–¹æ³•å¦‚ä¸‹ï¼š

é€šè¿‡ä¿®æ”¹ç›¸åº”çš„ lw æˆ– sw æŒ‡ä»¤ï¼Œå°†æœª 4 å­—èŠ‚å¯¹é½çš„åœ°å€çš„ä½ 2 ä½ï¼ˆäºŒè¿›åˆ¶æ ¼å¼ä¸‹ï¼‰ç½® 0 ï¼Œå¾—åˆ°ç¬¦åˆå¯¹é½è¦æ±‚çš„åœ°å€ã€‚ä¾‹å¦‚ï¼šå¯¹äºåœ°å€0x7f000009ï¼Œéœ€è¦å°†å…¶ä¿®æ”¹ä¸º0x7f000008ï¼ˆå³ä¿®æ”¹ååœ°å€ new_addr = old_addr & ~0x3ï¼‰ï¼Œæ–¹å¯å¾—åˆ°ç¬¦åˆè¦æ±‚çš„åœ°å€ã€‚æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬è¦æ±‚ä»…ä¿®æ”¹æŒ‡ä»¤ä¸­çš„**ç«‹å³æ•°éƒ¨åˆ†**ï¼Œä¸è¦ä¿®æ”¹ä»»ä½•å¯„å­˜å™¨ä¸­çš„å€¼ã€‚

åœ¨å¼‚å¸¸å¤„ç†å®Œæˆï¼Œè¿”å›ç”¨æˆ·æ€ä¹‹å‰ï¼Œéœ€è¦è¾“å‡ºç›¸åº”ä¿¡æ¯ï¼š

- lw å¤„ç†å®Œæˆï¼š

    ```c
    printk("AdEL handled, new imm is : %04x\n", new_inst & 0xffff); // è¿™é‡Œçš„ new_inst æ›¿æ¢ä¸ºä¿®æ”¹åçš„æŒ‡ä»¤
    ```

- swå¤„ç†å®Œæˆï¼š

    ```c
    printk("AdES handled, new imm is : %04x\n", new_inst & 0xffff); // è¿™é‡Œçš„ new_inst æ›¿æ¢ä¸ºä¿®æ”¹åçš„æŒ‡ä»¤
    ```

---
é˜…è¯»å¾€å¹´åšå®¢å’Œæœ¬é¢˜æç¤ºï¼Œå¯ä»¥å‘ç°å¤§ä½“æµç¨‹å°±æ˜¯ä¸‰æ­¥ï¼š

1. åœ¨ kern/genex.S ä¸­ä½¿ç”¨`BUILD_HANDLER`å®æ„å»ºæ–°çš„å¼‚å¸¸å¤„ç†å‡½æ•°ï¼š
   
   ```c
   BUILD_HANDLER adel do_adel
   BUILD_HANDLER ades do_ades
   ```

2. åœ¨ kern/traps.c ä¸­å£°æ˜`handle`å‡½æ•°å¹¶ä¿®æ”¹å¼‚å¸¸å‘é‡ç»„ï¼š

    ```c
    extern void handle_adel(void);
    extern void handle_ades(void);

    // exception_handlers è¯·æŒ‰ä»¥ä¸‹ä»£ç å®ç°
    void (*exception_handlers[32])(void) = {
        [0 ... 31] = handle_reserved,
        [0] = handle_int,
        [2 ... 3] = handle_tlb,
        [4] = handle_adel,
        [5] = handle_ades,
    #if !defined(LAB) || LAB >= 4
        [1] = handle_mod,
        [8] = handle_sys,
    #endif
    };
    ```

3. åœ¨ kern/traps.c ä¸­å®ç°å¼‚å¸¸å¤„ç†å‡½æ•°ï¼Œä¸‹é¢æˆ‘ä»¬ä»¥`do_adel`ä¸ºä¾‹ï¼ˆ`do_ades`å‡ ä¹å®Œå…¨ç›¸åŒï¼‰ï¼š
    
    é¢˜é¢ç»™å‡ºè¯¥å‡½æ•°çš„å‚æ•°å’Œæç¤ºï¼š

    ```c
    void do_adel(struct Trapframe *tf) {
        // åœ¨æ­¤å®ç°ç›¸åº”æ“ä½œä»¥ä½¿ä¿®æ”¹åæŒ‡ä»¤ç¬¦åˆè¦æ±‚
    }
    ```

    > æœ¬é¢˜æ¶‰åŠå¯¹å¯„å­˜å™¨å€¼çš„è¯»å–ã€‚ä½ éœ€è¦è®¿é—®ä¿å­˜ç°åœºçš„ Trapframe ç»“æ„ä½“ï¼ˆå®šä¹‰åœ¨ include/trap.h ä¸­ï¼‰ä¸­å¯¹åº”é€šç”¨å¯„å­˜å™¨ã€‚


    > æœ¬é¢˜æ¶‰åŠå¯¹å†…å­˜çš„è®¿é—®ï¼Œç”±äºæˆ‘ä»¬è¦ä¿®æ”¹çš„æŒ‡ä»¤éƒ¨åˆ†åœ¨ kuseg åŒºé—´ï¼Œè¿™ä¸€éƒ¨åˆ†çš„è™šæ‹Ÿåœ°å€éœ€è¦é€šè¿‡ TLB æ¥è·å–ç‰©ç†åœ°å€ã€‚æˆ‘ä»¬è®¾ç½®äº†ç¨‹åºä¸­ä¿å­˜æ“ä½œæŒ‡ä»¤ä»£ç çš„.textèŠ‚æƒé™ä¸ºåªè¯»ï¼Œè¿™éƒ¨åˆ†ç©ºé—´åœ¨é¡µè¡¨ä¸­ä»…è¢«æ˜ å°„ä¸º PTE_Vï¼Œè€Œä¸å¸¦æœ‰ PTE_D æƒé™ï¼Œå› æ­¤ç»ç”±é¡µè¡¨é¡¹æ— æ³•å¯¹ç‰©ç†é¡µè¿›è¡Œå†™æ“ä½œã€‚å¯ä»¥è€ƒè™‘æŸ¥è¯¢`curenv`çš„é¡µè¡¨è·å–å¯¹åº”æŒ‡ä»¤çš„ç‰©ç†åœ°å€ï¼Œå†è½¬åŒ–ä¸º kseg0çš„è™šæ‹Ÿåœ°å€ï¼Œä»è€Œä¿®æ”¹ç›¸åº”å†…å®¹ã€‚
    
    åœ¨ä¸Šæœºå‰ï¼Œæˆ‘å’Œèˆå‹å¯¹æ¯”äº†2024å¹´å’Œ2023å¹´é¢˜ç›®ï¼Œå‘ç°æµç¨‹å·®å¼‚å·¨å¤§ï¼šå‰è€…ååˆ†ç®€å•ï¼Œç›´æ¥è§£å¼•ç”¨`tf->cp0_epc`æ‹¿åˆ°æŒ‡ä»¤è¿›è¡Œä¿®æ”¹å³å¯ï¼Œè¿™æ˜¯å› ä¸ºè¯¥é¢˜ä¸è¦æ±‚ä¿®æ”¹å—å®³æŒ‡ä»¤ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸€å®šçš„æ ¼å¼ç›´æ¥å¤„ç†æ•°æ®ï¼Œéšåè®© EPC + 4 è¿›å…¥ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼›åè€…è¾ƒä¸ºç¹çï¼Œä¸ä»Šå¹´é¢˜ç›®ä¸€æ ·ï¼Œéœ€è¦ä¿®æ”¹å—å®³æŒ‡ä»¤ï¼Œå› æ­¤éœ€è¦èµ°ä¸€éæç¤ºä¸­çš„æµç¨‹ã€‚

    æˆ‘å‚è€ƒ2023å¹´ä¸€ä½[å­¦é•¿çš„åšå®¢](https://cookedbear.top/p/20326.html)ï¼Œå¾—åˆ°å¦‚ä¸‹å–å—å®³æŒ‡ä»¤çš„ä»£ç ï¼š

    ```c
    u_int badva = tf->cp0_epc;

 	Pde *pgdir = curenv->env_pgdir;
	Pte **ppte = NULL;
	struct Page *p = page_lookup(pgdir, badva, ppte);
	u_int badpa = page2pa(p) + (badva & 0xfff);
	u_int *badk0va = 0x80000000 | badpa;
	u_int code = *badk0va;
    ```

    å–å‡º`base`ã€`regs[base]`å’Œ`imm`ï¼š

    ```c
    u_int base = (code & 0x3e00000) >> 21;
	u_int svalue = tf->regs[base];
 	u_int imm = (code & 0xffff);
    ```

    æ­¤åï¼ŒæŒ‰ç…§é¢˜å¹²è¦æ±‚çš„å¤„ç†æ–¹æ³•ä¿®æ”¹`imm`ã€å†™å›`badk0va`å¹¶è¾“å‡ºå³å¯ï¼š

    ```c
    u_int oldaddr = svalue + imm;
 	u_int newaddr = oldaddr & ~0x3;
 	imm += newaddr - oldaddr;

	code = code & 0xffff0000 | (imm & 0xffff);
	*badk0va = code;
	printk("AdEL handled, new imm is : %04x\n", code & 0xffff)
    ```

    é¢˜ç›®çº¦æŸæåˆ°**ä¸ä¿è¯**`imm`ä¸ºæ­£æ•°ï¼Œä½†è¿™é‡Œä¼¼ä¹ä¸ä¼šé€ æˆä»€ä¹ˆå½±å“ï¼Œ`imm`çš„å˜åŒ–å®Œå…¨å–å†³äº`newaddr`å’Œ`oldaddr`çš„å·®å€¼ï¼Œä¸`imm`æœ¬èº«çš„æ­£è´Ÿæ— å…³ã€‚

---
è‡³æ­¤ï¼Œæˆ‘ä»¬å°±è§£å†³äº†æœ¬æ¬¡ä¸Šæœºçš„ extra é¢˜ç›®ã€‚åœ¨ç ”ç©¶äº†å‰ä¸¤å¹´é¢˜ç›®çš„å‰æä¸‹ï¼Œå®Œæˆæœ¬é¢˜çš„é€Ÿåº¦å¯ä»¥å¾ˆå¿«ï¼Œç¬”è€…åœ¨ exam è€½è¯¯äº†è®¸ä¹…ï¼Œä½†è¿˜æ˜¯æå‰äº¤å·äº†ï¼›ç›¸åï¼Œå¦‚æœæ˜¯ç°åœºæŒ‰ç…§æç¤ºå†™å–æŒ‡æµç¨‹ï¼Œéš¾å…ä¼šæœ‰å·®é”™ã€‚å¯è§ï¼Œè¯¾ä¸‹è¿˜æ˜¯è¦åšä¸€äº›å‡†å¤‡å·¥ä½œçš„ã€‚
